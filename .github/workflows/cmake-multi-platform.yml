name: Build & Release (Windows)

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # -----------------------
      # 1) CHECKOUT
      # -----------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------
      # 2) INSTALAR QT
      # -----------------------
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.2'
          host: windows
          target: msvc2022_64

      # -----------------------
      # 3) CONFIGURAR CMAKE
      # -----------------------
      - name: Configure CMake
        run: cmake -S . -B build `
                   -G "Visual Studio 17 2022" `
                   -A x64 `
                   -DCMAKE_PREFIX_PATH="$env:QTDIR"

      # -----------------------
      # 4) COMPILAR
      # -----------------------
      - name: Build Release
        run: cmake --build build --config Release

      # -----------------------
      # 5) RODAR WINDEPLOYQT
      # -----------------------
      - name: Bundle Qt (windeployqt)
        shell: pwsh
        run: |
          $exe = "${{ github.workspace }}\build\Release\TomasuloSim.exe"
          Write-Host "Running windeployqt on $exe"
          & "$env:QTDIR\bin\windeployqt.exe" --release $exe

      # -----------------------
      # 6) GERAR ARQUIVO ZIP
      # -----------------------
      - name: Pack ZIP
        shell: pwsh
        run: |
          $deploy = "${{ github.workspace }}\deploy"
          $zip = "${{ github.workspace }}\TomasuloSim-windows-x64.zip"

          if (Test-Path $deploy) { Remove-Item $deploy -Recurse -Force }
          New-Item -ItemType Directory -Path $deploy | Out-Null

          Copy-Item -Path "${{ github.workspace }}\build\Release\*" -Destination $deploy -Recurse -Force

          if (Test-Path $zip) { Remove-Item $zip }

          Compress-Archive -Path "$deploy\*" -DestinationPath $zip -Force

      # -----------------------
      # 7) CRIAR RELEASE
      # -----------------------
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: TomasuloSim-windows-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
